networks:
  test:
    driver: bridge

services:
  miner1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: templar-miner-M111
    networks:
      - test
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets
      - ../logs:/app/logs
    environment:
      NODE_TYPE: miner
      WALLET_NAME: miner
      WALLET_HOTKEY: M1
      CUDA_DEVICE: cuda:0
      NETWORK: test
      DEBUG: "true"
      WANDB_API_KEY: ${WANDB_API_KEY}
      NETUID: 268
      HOST_CUDA_VERSION: 12.6
      R2_GRADIENTS_ACCOUNT_ID: ${R2_GRADIENTS_ACCOUNT_ID}
      R2_GRADIENTS_BUCKET_NAME: ${R2_GRADIENTS_BUCKET_NAME}
      R2_GRADIENTS_READ_ACCESS_KEY_ID: ${R2_GRADIENTS_READ_ACCESS_KEY_ID}
      R2_GRADIENTS_READ_SECRET_ACCESS_KEY: ${R2_GRADIENTS_READ_SECRET_ACCESS_KEY}
      R2_GRADIENTS_WRITE_ACCESS_KEY_ID: ${R2_GRADIENTS_WRITE_ACCESS_KEY_ID}
      R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY: ${R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_ACCOUNT_ID: ${R2_DATASET_ACCOUNT_ID}
      R2_DATASET_BUCKET_NAME: ${R2_DATASET_BUCKET_NAME}
      R2_DATASET_READ_ACCESS_KEY_ID: ${R2_DATASET_READ_ACCESS_KEY_ID}
      R2_DATASET_READ_SECRET_ACCESS_KEY: ${R2_DATASET_READ_SECRET_ACCESS_KEY}
      R2_DATASET_WRITE_ACCESS_KEY_ID: ${R2_DATASET_WRITE_ACCESS_KEY_ID}
      R2_DATASET_WRITE_SECRET_ACCESS_KEY: ${R2_DATASET_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_BUCKET_LIST: ${R2_DATASET_BUCKET_LIST}
      R2_AGGREGATOR_ACCOUNT_ID: ${R2_AGGREGATOR_ACCOUNT_ID}
      R2_AGGREGATOR_BUCKET_NAME: ${R2_AGGREGATOR_BUCKET_NAME}
      R2_AGGREGATOR_READ_ACCESS_KEY_ID: ${R2_AGGREGATOR_READ_ACCESS_KEY_ID}
      R2_AGGREGATOR_READ_SECRET_ACCESS_KEY: ${R2_AGGREGATOR_READ_SECRET_ACCESS_KEY}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "5" ]
              capabilities: [ gpu ]

  miner2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: templar-miner-M222
    networks:
      - test
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets
      - ../logs:/app/logs
    environment:
      NODE_TYPE: miner
      WALLET_NAME: miner
      WALLET_HOTKEY: M2
      CUDA_DEVICE: cuda:0
      NETWORK: test
      DEBUG: "true"
      WANDB_API_KEY: ${WANDB_API_KEY}
      NETUID: 268
      HOST_CUDA_VERSION: 12.6
      R2_GRADIENTS_ACCOUNT_ID: ${R2_GRADIENTS_ACCOUNT_ID}
      R2_GRADIENTS_BUCKET_NAME: ${R2_GRADIENTS_BUCKET_NAME}
      R2_GRADIENTS_READ_ACCESS_KEY_ID: ${R2_GRADIENTS_READ_ACCESS_KEY_ID}
      R2_GRADIENTS_READ_SECRET_ACCESS_KEY: ${R2_GRADIENTS_READ_SECRET_ACCESS_KEY}
      R2_GRADIENTS_WRITE_ACCESS_KEY_ID: ${R2_GRADIENTS_WRITE_ACCESS_KEY_ID}
      R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY: ${R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_ACCOUNT_ID: ${R2_DATASET_ACCOUNT_ID}
      R2_DATASET_BUCKET_NAME: ${R2_DATASET_BUCKET_NAME}
      R2_DATASET_READ_ACCESS_KEY_ID: ${R2_DATASET_READ_ACCESS_KEY_ID}
      R2_DATASET_READ_SECRET_ACCESS_KEY: ${R2_DATASET_READ_SECRET_ACCESS_KEY}
      R2_DATASET_WRITE_ACCESS_KEY_ID: ${R2_DATASET_WRITE_ACCESS_KEY_ID}
      R2_DATASET_WRITE_SECRET_ACCESS_KEY: ${R2_DATASET_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_BUCKET_LIST: ${R2_DATASET_BUCKET_LIST}
      R2_AGGREGATOR_ACCOUNT_ID: ${R2_AGGREGATOR_ACCOUNT_ID}
      R2_AGGREGATOR_BUCKET_NAME: ${R2_AGGREGATOR_BUCKET_NAME}
      R2_AGGREGATOR_READ_ACCESS_KEY_ID: ${R2_AGGREGATOR_READ_ACCESS_KEY_ID}
      R2_AGGREGATOR_READ_SECRET_ACCESS_KEY: ${R2_AGGREGATOR_READ_SECRET_ACCESS_KEY}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "6" ]
              capabilities: [ gpu ]

  validator:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: templar-validator-V11
    networks:
      - test
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets
      - ../logs:/app/logs
    environment:
      NODE_TYPE: validator
      WALLET_NAME: validator
      WALLET_HOTKEY: default
      CUDA_DEVICE: cuda:0
      NETWORK: test
      DEBUG: "true"
      WANDB_API_KEY: ${WANDB_API_KEY}
      NETUID: 268
      HOST_CUDA_VERSION: 12.6
      R2_GRADIENTS_ACCOUNT_ID: ${R2_GRADIENTS_ACCOUNT_ID}
      R2_GRADIENTS_BUCKET_NAME: ${R2_GRADIENTS_BUCKET_NAME}
      R2_GRADIENTS_READ_ACCESS_KEY_ID: ${R2_GRADIENTS_READ_ACCESS_KEY_ID}
      R2_GRADIENTS_READ_SECRET_ACCESS_KEY: ${R2_GRADIENTS_READ_SECRET_ACCESS_KEY}
      R2_GRADIENTS_WRITE_ACCESS_KEY_ID: ${R2_GRADIENTS_WRITE_ACCESS_KEY_ID}
      R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY: ${R2_GRADIENTS_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_ACCOUNT_ID: ${R2_DATASET_ACCOUNT_ID}
      R2_DATASET_BUCKET_NAME: ${R2_DATASET_BUCKET_NAME}
      R2_DATASET_READ_ACCESS_KEY_ID: ${R2_DATASET_READ_ACCESS_KEY_ID}
      R2_DATASET_READ_SECRET_ACCESS_KEY: ${R2_DATASET_READ_SECRET_ACCESS_KEY}
      R2_DATASET_WRITE_ACCESS_KEY_ID: ${R2_DATASET_WRITE_ACCESS_KEY_ID}
      R2_DATASET_WRITE_SECRET_ACCESS_KEY: ${R2_DATASET_WRITE_SECRET_ACCESS_KEY}
      R2_DATASET_BUCKET_LIST: ${R2_DATASET_BUCKET_LIST}
      R2_AGGREGATOR_ACCOUNT_ID: ${R2_AGGREGATOR_ACCOUNT_ID}
      R2_AGGREGATOR_BUCKET_NAME: ${R2_AGGREGATOR_BUCKET_NAME}
      R2_AGGREGATOR_READ_ACCESS_KEY_ID: ${R2_AGGREGATOR_READ_ACCESS_KEY_ID}
      R2_AGGREGATOR_READ_SECRET_ACCESS_KEY: ${R2_AGGREGATOR_READ_SECRET_ACCESS_KEY}
      RUN_AGGREGATOR: "true"
      RUN_EVALUATOR: "true"
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "1", "2", "3" ]
              capabilities: [ gpu ]
